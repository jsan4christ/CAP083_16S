"0","set.seed(1982)"
"0","NoBVNoSTI <- subset(dt.ps1.v1.cst.rich, (dt.ps1.v1.cst.rich$bvscat == ""Negative"" & dt.ps1.v1.cst.rich$STI == 0))"
"0","sampleIdsNoBvStis <- NoBVNoSTI$SampleID"
"0","ps1.v1.cst.glom.Species.raNoBS <- prune_samples(get_variable(ps1.v1.cst.glom.Species.ra, ""SampleID"") %in% sampleIdsNoBvStis, ps1.v1.cst.glom.Species.ra)"
"0","ps1.v1.cst.glom.Species.raNoBS"
"1","phyloseq-class experiment-level object"
"1","
"
"1","otu_table()   OTU Table:         [ 62 taxa and 51 samples ]"
"1","
"
"1","sample_data() Sample Data:       [ 51 samples by 83 sample variables ]"
"1","
"
"1","tax_table()   Taxonomy Table:    [ 62 taxa by 7 taxonomic ranks ]"
"1","
"
"1","phy_tree()    Phylogenetic Tree: [ 62 tips and 61 internal nodes ]"
"1","
"
"0","#View(data.frame(sample_data(ps1.cst.glom.Species.raNoBS)))"
"0","library(data.table)"
"0","ps1.v1.cst.glom.Species.raNoBS <- prune_samples(sample_sums(ps1.v1.cst.glom.Species.raNoBS) > 0 , ps1.v1.cst.glom.Species.raNoBS)"
"0","ps1.v1.cst.glom.Species.raNoBS <- prune_taxa(taxa_sums(ps1.v1.cst.glom.Species.raNoBS) > 0 , ps1.v1.cst.glom.Species.raNoBS)"
"0","ps2.x.merged <- merge_less_than_top(ps1.v1.cst.glom.Species.raNoBS)"
"0","#Reorganise factors to known CT naming convention"
"0","#cstLevels <- c(""CST4"", ""CST3"", ""CST1"", ""CST2"")"
"0","#cstLabels <- c(""CST1"", ""CST2"", ""CST3"", ""CST4"")"
"0","#sample_data(ps2.x.merged)$CSTs <- factor(sample_data(ps2.x.merged)$CSTs, levels = cstLevels, labels = cstLabels)"
"0","#levels(sample_data(ps2.x.merged)$CSTs)"
"0","# create dataframe from phyloseq object"
"0","dat <- data.table(psmelt(ps2.x.merged))"
"0","# convert Phylum to a character vector from a factor because R"
"0","#dat$Species <- as.character(dat$Species)"
"0","#sort samples by CSTs and Abundance"
"0","dat <- dat[order(sim_CST, Abundance), ]"
"0","dat$ParticipantID <- as.character(dat$ParticipantID)"
"0","#Bar plot"
"0","colourCount = length(unique(dat$Sample))"
"0","getPalette = colorRampPalette(brewer.pal(9, ""Set1""))"
"0","p <- ggplot(dat, aes(x=ParticipantID, y=Abundance, fill=Species)) + "
"0","  geom_bar(aes(), stat=""identity"", position=""stack"") + "
"0","  #scale_fill_manual(values=getPalette(colourCount)) + "
"0","  scale_fill_manual(values=customPalette) + "
"0","  #scale_fill_viridis_d() +"
"0","  theme(legend.position=""bottom"","
"0","        #axis.text.x = element_blank(),"
"0","        axis.text.x = element_text(size = 6, angle = 90),"
"0","        legend.text = element_text(size = 8)) + "
"0","  facet_grid(. ~ sim_CST, drop=TRUE,scale=""free"",space=""free_x"") + "
"0","  guides(fill=guide_legend(nrow=7)) "
"0","p <- p+ theme(strip.background = element_rect(fill=""white"", colour = ""white"", size = 4),"
"0","              strip.text = element_text(face=""bold"", size=7),"
"0","              panel.spacing = unit(0, ""lines"") #get rid of facet margins"
"0",")"
"0","g <- ggplot_gtable(ggplot_build(p))"
"0","stripr <- which(grepl('strip-t', g$layout$name))"
"0","fills <- CSTsPallete "
"0","k <- 1"
"0","for (i in stripr) {"
"0","  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))"
"0","  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]"
"0","  k <- k+1"
"0","}"
"0","grid.newpage()"
