"0","set.seed(1982)"
"0","ps1.v1 <- subset_samples(ps1, VisitCode == 1000)"
"0","#Remove taxa not associated with any samples anymore"
"0","ps1.v1 <- prune_taxa(taxa_sums(ps1.v1) > 0, ps1.v1)"
"0","## Estimate richness"
"0","ps1.v1 <- cestimate_richness(ps1.v1)"
"0","#Agglomerate at species level"
"0","ps1.v1.cst.glom.Species <- tax_glom(ps1.v1, taxrank = ""Species"")"
"0","## Transform to relative abundance"
"0","ps1.v1.cst.glom.Species.ra <- transform_sample_counts(ps1.v1.cst.glom.Species, function(OTU) OTU/sum(OTU))"
"0","dt.ps1.v1.sample_data <-  data.frame(sample_data(ps1.v1.cst.glom.Species.ra))"
"0","  "
"0","NoBVNoSTI <- subset(dt.ps1.v1.sample_data, (dt.ps1.v1.sample_data$bvscat == ""Negative"" & dt.ps1.v1.sample_data$STI == 0))"
"0","sampleIdsNoBvStis <- NoBVNoSTI$SampleID"
"0","ps1.v1.cst.glom.Species.raNoBS <- prune_samples(get_variable(ps1.v1.cst.glom.Species.ra, ""SampleID"") %in% sampleIdsNoBvStis, ps1.v1.cst.glom.Species.ra)"
"0","ps1.v1.cst.glom.Species.raNoBS"
"1","phyloseq-class experiment-level object"
"1","
"
"1","otu_table()   OTU Table:         [ 62 taxa and 51 samples ]"
"1","
"
"1","sample_data() Sample Data:       [ 51 samples by 83 sample variables ]"
"1","
"
"1","tax_table()   Taxonomy Table:    [ 62 taxa by 7 taxonomic ranks ]"
"1","
"
"1","phy_tree()    Phylogenetic Tree: [ 62 tips and 61 internal nodes ]"
"1","
"
"0","ps1.v1.cst.glom.Species.raNoBS <- prune_samples(sample_sums(ps1.v1.cst.glom.Species.raNoBS) > 0 , ps1.v1.cst.glom.Species.raNoBS)"
"0","ps1.v1.cst.glom.Species.raNoBS <- prune_taxa(taxa_sums(ps1.v1.cst.glom.Species.raNoBS) > 0 , ps1.v1.cst.glom.Species.raNoBS)"
"0","ps2.x.merged <- merge_less_than_top(ps1.v1.cst.glom.Species.raNoBS)"
"0","# create dataframe from phyloseq object"
"0","dat <- data.table(psmelt(ps2.x.merged))"
"0","#sort samples by CSTs and Abundance"
"0","dat <- dat[order(sim_CST, Abundance), ]"
"0","dat$ParticipantID <- as.character(dat$ParticipantID)"
"0","#Bar plot"
"0","colourCount = length(unique(dat$Sample))"
"0","getPalette = colorRampPalette(brewer.pal(9, ""Set1""))"
"0","p <- ggplot(dat, aes(x=ParticipantID, y=Abundance, fill=Species)) + "
"0","  geom_bar(aes(), stat=""identity"", position=""stack"") + "
"0","  #scale_fill_manual(values=getPalette(colourCount)) + "
"0","  scale_fill_manual(values=customPalette) + "
"0","  #scale_fill_viridis_d() +"
"0","  theme(legend.position=""bottom"","
"0","        #axis.text.x = element_blank(),"
"0","        axis.text.x = element_text(size = 6, angle = 90),"
"0","        legend.text = element_text(size = 8)) + "
"0","  facet_grid(. ~ sim_CST, drop=TRUE,scale=""free"",space=""free_x"") + "
"0","  guides(fill=guide_legend(nrow=7)) "
"0","p <- p+ theme(strip.background = element_rect(fill=""white"", colour = ""white"", size = 4),"
"0","              strip.text = element_text(face=""bold"", size=7),"
"0","              panel.spacing = unit(0, ""lines"") #get rid of facet margins"
"0",")"
"0","g <- ggplot_gtable(ggplot_build(p))"
"0","stripr <- which(grepl('strip-t', g$layout$name))"
"0","fills <- CSTsPalleteNamed[levels(dat$sim_CST)] "
"0","k <- 1"
"0","for (i in stripr) {"
"0","  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))"
"0","  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]"
"0","  k <- k+1"
"0","}"
"0","grid.newpage()"
